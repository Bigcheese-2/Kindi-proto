# Story 2.1: Network Graph Component

## Status

Done

## Story

**As an** analyst,
**I want** to see entity relationships in a network graph,
**so that** I can understand connections between entities.

## Acceptance Criteria

1: react-force-graph is integrated into the application
2: Entities are displayed as nodes with appropriate styling
3: Relationships are displayed as edges with directional indicators
4: Node styling reflects entity types through colors and icons
5: Basic zoom and pan functionality is implemented
6: Graph layout is optimized for readability

## Tasks / Subtasks

- [x] Set up react-force-graph integration (AC: 1)
  - [x] Install react-force-graph and dependencies
  - [x] Create GraphComponent wrapper for react-force-graph
  - [x] Configure basic graph settings and properties
  - [x] Implement canvas rendering for performance

- [x] Implement entity node visualization (AC: 2)
  - [x] Create node rendering function with entity data
  - [x] Implement node sizing based on entity importance
  - [x] Add tooltips for node information on hover
  - [x] Implement node selection functionality

- [x] Implement relationship edge visualization (AC: 3)
  - [x] Create edge rendering function with relationship data
  - [x] Add directional arrows for directed relationships
  - [x] Style edges based on relationship type and strength
  - [x] Implement edge labels for relationship information

- [x] Create entity type styling system (AC: 4)
  - [x] Define color scheme for different entity types
  - [x] Create icon mapping for entity types
  - [x] Implement visual differentiation for entity categories
  - [x] Add legend for entity type colors and icons

- [x] Implement graph navigation controls (AC: 5)
  - [x] Add zoom in/out controls
  - [x] Implement pan functionality
  - [x] Add reset view button
  - [x] Implement fit-to-view functionality

- [x] Optimize graph layout (AC: 6)
  - [x] Configure force-directed layout parameters
  - [x] Implement node clustering for dense areas
  - [x] Add layout optimization for readability
  - [x] Implement performance optimizations for large graphs

## Dev Notes

### Visualization Component Structure

[Source: architecture/technical-architecture-document.md#component-architecture]

The Graph Component should be implemented in the visualization components directory:

```
app/
└── components/
    └── visualizations/
        └── graph/
            ├── GraphComponent.tsx       # Main graph component
            ├── GraphControls.tsx        # Zoom, pan controls
            ├── NodeRenderer.tsx         # Custom node rendering
            ├── EdgeRenderer.tsx         # Custom edge rendering
            └── GraphLegend.tsx          # Entity type legend
```

### Data Transformation

[Source: architecture/technical-architecture-document.md#data-transformation-indexing]

Transform the raw entity and relationship data into the format required by react-force-graph:

```typescript
// Transform entities to graph nodes
const transformEntitiesToNodes = (entities: Entity[]): NodeObject[] => {
  return entities.map(entity => ({
    id: entity.id,
    name: entity.name,
    type: entity.type,
    val: entity.risk || 1, // Use risk for node size if available
    color: getColorForEntityType(entity.type),
    attributes: entity.attributes,
    metadata: entity.metadata,
  }));
};

// Transform relationships to graph links
const transformRelationshipsToLinks = (relationships: Relationship[]): LinkObject[] => {
  return relationships.map(rel => ({
    source: rel.source,
    target: rel.target,
    type: rel.type,
    directed: rel.directed,
    strength: rel.strength || 1,
    attributes: rel.attributes,
  }));
};
```

### React-Force-Graph Configuration

[Source: architecture/technical-architecture-document.md#visualization-libraries]

The react-force-graph library should be configured with the following options:

```typescript
<ForceGraph2D
  graphData={graphData}
  nodeLabel={node => node.name}
  nodeColor={node => getColorForEntityType(node.type)}
  nodeVal={node => node.val}
  linkDirectionalArrowLength={link => link.directed ? 3 : 0}
  linkDirectionalArrowRelPos={1}
  linkWidth={link => link.strength}
  onNodeClick={handleNodeClick}
  onLinkClick={handleLinkClick}
  d3Force={forceConfig}
/>
```

### Performance Optimizations

[Source: architecture/technical-architecture-document.md#performance-optimization]

Implement the following performance optimizations:

1. **Canvas Rendering**: Use canvas rendering instead of SVG for better performance with large graphs
2. **Level of Detail**: Adjust detail level based on zoom level
3. **Node Clustering**: Implement clustering for dense areas of the graph
4. **Lazy Loading**: Only load visible parts of the graph for large datasets

### Selection Integration

[Source: architecture/technical-architecture-document.md#synchronization-architecture]

The graph component should integrate with the SelectionContext:

```typescript
const { selectedEntityIds, selectEntity } = useContext(SelectionContext);

// Handle node selection
const handleNodeClick = useCallback(
  node => {
    selectEntity(node.id);
  },
  [selectEntity]
);

// Highlight selected nodes
const highlightNodes = useCallback(() => {
  return selectedEntityIds.map(id => graphData.nodes.find(node => node.id === id));
}, [selectedEntityIds, graphData]);
```

### Testing

#### Testing Strategy

[Source: architecture/technical-architecture-document.md#testing-strategy]

For this story, focus on:

1. **Component Testing**: Test the graph component rendering and interactions
2. **Performance Testing**: Test with large datasets to ensure performance
3. **Integration Testing**: Test integration with the data context and selection context

Test files should be organized in the `tests` directory with appropriate subdirectories for unit and integration tests.

## Change Log

| Date       | Version | Description         | Author       |
| ---------- | ------- | ------------------- | ------------ |
| 2023-06-18 | 0.1     | Initial story draft | Scrum Master |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4

### Debug Log References

No major debug issues encountered. SSR compatibility handled via dynamic imports.

### Completion Notes List

- ✅ Successfully integrated react-force-graph-2d for network visualization
- ✅ Implemented dynamic component loading to avoid SSR issues
- ✅ Created comprehensive node and edge rendering with canvas objects
- ✅ Added entity type color mapping and visual differentiation
- ✅ Implemented selection, hover, and interaction functionality
- ✅ Created navigation controls for zoom, pan, and view fitting
- ✅ Added legend component for entity types and relationships

### File List

- app/components/visualizations/graph/GraphComponent.tsx
- app/components/visualizations/graph/GraphControls.tsx
- app/components/visualizations/graph/GraphLegend.tsx
- app/components/visualizations/GraphPanel.tsx (updated)

## QA Results
